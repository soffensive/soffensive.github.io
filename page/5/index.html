<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.146.4"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>soffensive blog</title><meta name=Description content="This is my cool site"><meta property="og:url" content="https://soffensive.github.io/">
<meta property="og:site_name" content="soffensive blog"><meta property="og:title" content="soffensive blog"><meta property="og:description" content="This is my cool site"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="soffensive blog"><meta name=twitter:description content="This is my cool site"><meta name=twitter:site content="@evisneffos"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://soffensive.github.io/><link rel=alternate href=/index.xml type=application/rss+xml title="soffensive blog"><link rel=feed href=/index.xml type=application/rss+xml title="soffensive blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","url":"https:\/\/soffensive.github.io\/","inLanguage":"en","description":"This is my cool site","name":"soffensive blog"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="soffensive blog">soffensive blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/soffensive title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><a class=menu-item href=https://twitter.com/evisneffos title=Twitter rel="noopener noreffer" target=_blank><i class='fab fa-twitter fa-fw'></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="soffensive blog">soffensive blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/soffensive title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a class=menu-item href=https://twitter.com/evisneffos title=Twitter rel="noopener noreffer" target=_blank><i class='fab fa-twitter fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class="page home" data-home=posts><div class=home-profile><h1 class=home-title>soffensive blog</h1><div class=home-subtitle><div id=id-1 class=typeit></div></div><div class=links><a href=https://github.com/soffensive title=GitHub target=_blank rel="noopener noreffer me"><i class="fab fa-github fa-fw" aria-hidden=true></i></a><a href=https://twitter.com/evisneffos title=Twitter target=_blank rel="noopener noreffer me"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a></div></div><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/ctf/2017-08-04-small-challenge-from-gynvael-coldwin/>Small challenge from Gynvael Coldwin</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-08-04>2017-08-04</time></span>&nbsp;<span class=post-category>included in <a href=/categories/ctf-challenges/><i class="far fa-folder fa-fw" aria-hidden=true></i>CTF Challenges</a></span></div><div class=content><p>Gynvael Coldwin posted a small challenge at the end of his last podcast on Windows Kernel Debugging with Artem Shishkin:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Welcome back agent 1336.
</span></span><span class=line><span class=cl>No mail.
</span></span><span class=line><span class=cl>&gt; mission --take
</span></span><span class=line><span class=cl>MISSION 012               goo.gl/qudiHJ             DIFFICULTY: ██░░░░░░░░ [2╱10]
</span></span><span class=line><span class=cl>┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Our agents managed to install a hardware keylogger in suspects computer. After
</span></span><span class=line><span class=cl>they retrieved it and dumped the recorded data, here is what showed up:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  58 f0 58 1b f0 1b 58 f0 58 44 f0 44 2d f0 2d 2d f0 2d 35 f0 35 41 f0 41 29
</span></span><span class=line><span class=cl>  f0 29 59 43 f0 43 f0 59 29 f0 29 23 f0 23 44 f0 44 31 f0 31 52 f0 52 2c f0
</span></span><span class=line><span class=cl>  2c 29 f0 29 1b f0 1b 4d f0 4d 24 f0 24 1c f0 1c 42 f0 42 29 f0 29 12 42 f0
</span></span><span class=line><span class=cl>  42 f0 12 24 f0 24 35 f0 35 32 f0 32 44 f0 44 1c f0 1c 2d f0 2d 23 f0 23 49
</span></span><span class=line><span class=cl>  f0 49
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Could you help us decoded it to know what was typed?
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Good luck!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>If you decode the answer, put it in the comments under this video! If you write
</span></span><span class=line><span class=cl>a blogpost / post your solution online, please add a link in the comments too!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>P.S. I&#39;ll show/explain the solution on the stream in ~two weeks.
</span></span></code></pre></td></tr></table></div></div><p>Our first guess was that the characters use some well-known encoding such as ASCII, but this turned out to be wrong assumption. In order to obtain some knowledge about the structure of the recorded data, we ran some statistical analysis of the different byte values:</p></div><div class=post-footer><a href=/posts/ctf/2017-08-04-small-challenge-from-gynvael-coldwin/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/ctf/>Ctf</a></div></div></article><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/practical-reverse-engineering/2017-07-30-practical-reverse-engineering-exercise-solutions-page-35-exercise-7/>Practical Reverse Engineering Exercise Solutions: Page 35 / Exercise 7</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-07-30>2017-07-30</time></span>&nbsp;<span class=post-category>included in <a href=/categories/practical-reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Practical Reverse Engineering</a></span></div><div class=content><p>Exercise 7 on page 35:</p><blockquote><p>Sample H. The function <code>sub_10BB6</code> has a loop searching for something. First recover the function prototype and then infer the types based on the context. Hint: You should probably have a copy of the PE specification nearby.</p></blockquote><p>Due to alignment issues, our routine is located at <code>10BB2</code> and has the following disassembly:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nl>sub_10BB2:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>     <span class=nb>eax</span><span class=p>,</span> <span class=p>[</span><span class=nb>esp</span><span class=o>+</span><span class=mi>4</span><span class=p>]</span>   
</span></span><span class=line><span class=cl> <span class=nf>push</span>    <span class=nb>ebx</span>    
</span></span><span class=line><span class=cl> <span class=nf>push</span>    <span class=nb>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>     <span class=nb>esi</span><span class=p>,</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mh>3Ch</span><span class=p>]</span> 
</span></span><span class=line><span class=cl> <span class=nf>add</span>     <span class=nb>esi</span><span class=p>,</span> <span class=nb>eax</span>   
</span></span><span class=line><span class=cl> <span class=nf>movzx</span>   <span class=nb>eax</span><span class=p>,</span> <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>esi</span><span class=o>+</span><span class=mh>14h</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>xor</span>     <span class=nb>ebx</span><span class=p>,</span> <span class=nb>ebx</span>
</span></span><span class=line><span class=cl> <span class=nf>cmp</span>     <span class=p>[</span><span class=nb>esi</span><span class=o>+</span><span class=mi>6</span><span class=p>],</span> <span class=nb>bx</span>
</span></span><span class=line><span class=cl> <span class=nf>push</span>    <span class=nb>edi</span>
</span></span><span class=line><span class=cl> <span class=nf>lea</span>     <span class=nb>edi</span><span class=p>,</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=nb>esi</span><span class=o>+</span><span class=mh>18h</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>jbe</span>     <span class=nv>short</span> <span class=nv>loc_10BEB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>loc_10BCE:</span>                            
</span></span><span class=line><span class=cl> <span class=nf>push</span>    <span class=p>[</span><span class=nb>esp</span><span class=o>+</span><span class=mh>0Ch</span><span class=o>+</span><span class=nv>arg_4</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>push</span>    <span class=nb>edi</span>
</span></span><span class=line><span class=cl> <span class=nf>call</span>    <span class=nb>ds</span><span class=p>:</span><span class=kt>dword</span><span class=nv>_169A4</span>
</span></span><span class=line><span class=cl> <span class=nf>test</span>    <span class=nb>eax</span><span class=p>,</span> <span class=nb>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>     <span class=nb>ecx</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>     <span class=nb>ecx</span>
</span></span><span class=line><span class=cl> <span class=nf>jz</span>      <span class=nv>short</span> <span class=nv>loc_10BF3</span>
</span></span><span class=line><span class=cl> <span class=nf>movzx</span>   <span class=nb>eax</span><span class=p>,</span> <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>esi</span><span class=o>+</span><span class=mi>6</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>     <span class=nb>edi</span><span class=p>,</span> <span class=mh>28h</span>
</span></span><span class=line><span class=cl> <span class=nf>inc</span>     <span class=nb>ebx</span>
</span></span><span class=line><span class=cl> <span class=nf>cmp</span>     <span class=nb>ebx</span><span class=p>,</span> <span class=nb>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>jb</span>      <span class=nv>short</span> <span class=nv>loc_10BCE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>loc_10BEB:</span>                              
</span></span><span class=line><span class=cl> <span class=nf>xor</span>     <span class=nb>eax</span><span class=p>,</span> <span class=nb>eax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>loc_10BED:</span>                             
</span></span><span class=line><span class=cl> <span class=nf>pop</span>     <span class=nb>edi</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>     <span class=nb>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>     <span class=nb>ebx</span>
</span></span><span class=line><span class=cl> <span class=nf>retn</span>    <span class=mi>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>loc_10BF3:</span>                             
</span></span><span class=line><span class=cl>                <span class=nf>mov</span>     <span class=nb>eax</span><span class=p>,</span> <span class=nb>edi</span>
</span></span><span class=line><span class=cl>                <span class=nf>jmp</span>     <span class=nv>short</span> <span class=nv>loc_10BED</span>
</span></span></code></pre></td></tr></table></div></div><p>The PE file format and offsets have been described in detail here: <a href=http://www.sunshine2k.de/reversing/tuts/tut_pe.htm target=_blank rel="noopener noreffer">http://www.sunshine2k.de/reversing/tuts/tut_pe.htm</a></p></div><div class=post-footer><a href=/posts/practical-reverse-engineering/2017-07-30-practical-reverse-engineering-exercise-solutions-page-35-exercise-7/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/practical-reverse-engineering/>Practical Reverse Engineering</a>,&nbsp;<a href=/tags/x64/>X64</a>,&nbsp;<a href=/tags/x86/>X86</a></div></div></article><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/practical-reverse-engineering/2017-07-22-practical-reverse-engineering-exercise-solutions-page-35-exercise-6/>Practical Reverse Engineering Exercise Solutions: Page 35 / Exercise 6</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-07-22>2017-07-22</time></span>&nbsp;<span class=post-category>included in <a href=/categories/practical-reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Practical Reverse Engineering</a></span></div><div class=content><p>Exercise 6 on page 35 of the book Practical Reverse Engineering presents us with a malware samples.</p><p>These can be downloaded at the following page:</p><p><a href=https://grsecurity.net/malware_research/ target=_blank rel="noopener noreffer">https://grsecurity.net/malware_research/</a></p><p>In this exercise, we are expected to have a look at the following routine <code>sub_13842</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013842</span> <span class=nf>sub_13842</span>      
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013842</span>                 <span class=nf>mov</span>     <span class=nb>eax</span><span class=p>,</span> <span class=p>[</span><span class=nb>ecx</span><span class=o>+</span><span class=mh>60h</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013845</span>                 <span class=nf>push</span>    <span class=nb>esi</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013846</span>                 <span class=nf>mov</span>     <span class=nb>esi</span><span class=p>,</span> <span class=p>[</span><span class=nb>edx</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013849</span>                 <span class=nf>dec</span>     <span class=kt>byte</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>ecx</span><span class=o>+</span><span class=mh>23h</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0001384</span><span class=nf>C</span>                 <span class=nv>sub</span>     <span class=nb>eax</span><span class=p>,</span> <span class=mh>24h</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0001384</span><span class=nf>F</span>                 <span class=nv>mov</span>     <span class=p>[</span><span class=nb>ecx</span><span class=o>+</span><span class=mh>60h</span><span class=p>],</span> <span class=nb>eax</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013852</span>                 <span class=nf>mov</span>     <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mh>14h</span><span class=p>],</span> <span class=nb>edx</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013855</span>                 <span class=nf>movzx</span>   <span class=nb>eax</span><span class=p>,</span> <span class=kt>byte</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>eax</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013858</span>                 <span class=nf>push</span>    <span class=nb>ecx</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>00013859</span>                 <span class=nf>push</span>    <span class=nb>edx</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0001385</span><span class=nf>A</span>                 <span class=nv>call</span>    <span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>esi</span><span class=o>+</span><span class=nb>eax</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=mh>38h</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0001385</span><span class=nf>E</span>                 <span class=nv>pop</span>     <span class=nb>esi</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0001385</span><span class=nf>F</span>                 <span class=nv>retn</span>
</span></span></code></pre></td></tr></table></div></div><p>Firstly, we see that the function prototype takes two parameters, which are not saved on the stack but in the two registers <code>ecx</code> and <code>edx</code>. This can be deducted from the fact that these two registers are immediately referenced without prior initialization.</p></div><div class=post-footer><a href=/posts/practical-reverse-engineering/2017-07-22-practical-reverse-engineering-exercise-solutions-page-35-exercise-6/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/practical-reverse-engineering/>Practical Reverse Engineering</a>,&nbsp;<a href=/tags/x64/>X64</a>,&nbsp;<a href=/tags/x86/>X86</a></div></div></article><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-rtlvalidateunicodestring/>Practical Reverse Engineering Exercise Solutions: RtlValidateUnicodeString</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-07-16>2017-07-16</time></span>&nbsp;<span class=post-category>included in <a href=/categories/practical-reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Practical Reverse Engineering</a></span></div><div class=content><p>This blog post contains my solution for the decompilation exercise of the <code>RtlValidateUnicodeString</code> function in the Windows Kernel. The following contains the disassembly without annotations:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>kd</span><span class=o>&gt;</span> <span class=nv>uf</span> <span class=nv>rtlvalidateunicodestring</span>
</span></span><span class=line><span class=cl><span class=nf>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f6c</span> <span class=mi>8</span><span class=nv>bff</span>            <span class=nv>mov</span>     <span class=nb>edi</span><span class=p>,</span><span class=nb>edi</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f6e</span> <span class=mi>55</span>              <span class=nv>push</span>    <span class=nb>ebp</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f6f</span> <span class=mi>8</span><span class=nv>bec</span>            <span class=nv>mov</span>     <span class=nb>ebp</span><span class=p>,</span><span class=nb>esp</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f71</span> <span class=mi>837</span><span class=nv>d0800</span>        <span class=nv>cmp</span>     <span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>ebp</span><span class=o>+</span><span class=mi>8</span><span class=p>],</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f75</span> <span class=mi>0</span><span class=nv>f85fc380300</span>    <span class=nv>jne</span>     <span class=nv>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=o>+</span><span class=mh>0xb</span> <span class=p>(</span><span class=mi>776</span><span class=nv>ba877</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=o>+</span><span class=mh>0x12</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f7b</span> <span class=mi>6800010000</span>      <span class=nv>push</span>    <span class=mh>100h</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f80</span> <span class=nv>ff750c</span>          <span class=nv>push</span>    <span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>ebp</span><span class=o>+</span><span class=mh>0Ch</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f83</span> <span class=nv>e809000000</span>      <span class=nv>call</span>    <span class=nv>ntdll</span><span class=err>!</span><span class=nv>RtlUnicodeStringValidateEx</span> <span class=p>(</span><span class=mi>77686</span><span class=nv>f91</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=o>+</span><span class=mh>0x1f</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f88</span> <span class=mi>5</span><span class=nv>d</span>              <span class=nv>pop</span>     <span class=nb>ebp</span>
</span></span><span class=line><span class=cl><span class=err>77686</span><span class=nf>f89</span> <span class=nv>c20800</span>          <span class=nv>ret</span>     <span class=mi>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=o>+</span><span class=mh>0xb</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>776</span><span class=nf>ba877</span> <span class=nv>b80d0000c0</span>      <span class=nv>mov</span>     <span class=nb>eax</span><span class=p>,</span><span class=mh>0C000000Dh</span>
</span></span><span class=line><span class=cl><span class=err>776</span><span class=nf>ba87c</span> <span class=nv>e907c7fcff</span>      <span class=nv>jmp</span>     <span class=nv>ntdll</span><span class=err>!</span><span class=nv>RtlValidateUnicodeString</span><span class=o>+</span><span class=mh>0x1f</span> <span class=p>(</span><span class=mi>77686</span><span class=nv>f88</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>The function prototype is given <a href=https://github.com/CaledoniaProject/kekeo-with-asn-vs2013/blob/d926de6096d6f6d797e38ced1b5cbdf56d1734b9/modules/kull_m_string.h target=_blank rel="noopener noreffer">here</a>:</p></div><div class=post-footer><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-rtlvalidateunicodestring/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/practical-reverse-engineering/>Practical Reverse Engineering</a>,&nbsp;<a href=/tags/x64/>X64</a>,&nbsp;<a href=/tags/x86/>X86</a></div></div></article><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-livekd-windbg-cheat-sheet/>Practical Reverse Engineering Exercise Solutions: LiveKd / WinDbg Cheat Sheet</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-07-16>2017-07-16</time></span>&nbsp;<span class=post-category>included in <a href=/categories/practical-reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Practical Reverse Engineering</a></span></div><div class=content><p>Here are a couple of commands I regularly use for reverse engineering:</p><ul><li><code>uf &lt;function></code>: Unassemble function</li><li><code>dt nt!_ktss</code>: Show the definition of the data structure <code>_ktss</code></li><li><code>?? sizeof(_ktss)</code>: Show the size the data structure <code>_ktss</code> occupies in memory</li><li><code>.hh uf</code>: Show help for the function <code>uf</code></li><li><code>x nt!*createfile*</code>: Search all functions having the string <code>createfile</code> in its name</li><li><code>!vtop &lt;PDPT-pointer> &lt;virtualAddress></code>: Compute physical address of given virtual address and the pointer to the page directory pointer table</li></ul></div><div class=post-footer><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-livekd-windbg-cheat-sheet/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/practical-reverse-engineering/>Practical Reverse Engineering</a>,&nbsp;<a href=/tags/windbg/>Windbg</a>,&nbsp;<a href=/tags/x64/>X64</a>,&nbsp;<a href=/tags/x86/>X86</a></div></div></article><article class="single summary" itemscope itemtype=http://schema.org/Article><h1 class=single-title itemprop="name headline"><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-kiinitializetss/>Practical Reverse Engineering Exercise Solutions: KiInitializeTSS</a></h1><div class=post-meta><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soffensive</a></span>&nbsp;<span class=post-publish>published on <time datetime=2017-07-16>2017-07-16</time></span>&nbsp;<span class=post-category>included in <a href=/categories/practical-reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Practical Reverse Engineering</a></span></div><div class=content><p>Another exercise for us is the decompilation of the <code>KiInitializeTSS</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>nt</span><span class=err>!</span><span class=nv>KiInitializeTSS</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>82847359</span> <span class=err>8</span><span class=nf>bff</span>            <span class=nv>mov</span>     <span class=nb>edi</span><span class=p>,</span><span class=nb>edi</span>
</span></span><span class=line><span class=cl><span class=err>8284735</span><span class=nf>b</span> <span class=mi>55</span>              <span class=nv>push</span>    <span class=nb>ebp</span>
</span></span><span class=line><span class=cl><span class=err>8284735</span><span class=nf>c</span> <span class=mi>8</span><span class=nv>bec</span>            <span class=nv>mov</span>     <span class=nb>ebp</span><span class=p>,</span><span class=nb>esp</span>
</span></span><span class=line><span class=cl><span class=err>8284735</span><span class=nf>e</span> <span class=mi>8</span><span class=nv>b4508</span>          <span class=nv>mov</span>     <span class=nb>eax</span><span class=p>,</span><span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>ebp</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>82847361</span> <span class=nf>b9ac200000</span>      <span class=nv>mov</span>     <span class=nb>ecx</span><span class=p>,</span><span class=mh>20ACh</span>
</span></span><span class=line><span class=cl><span class=err>82847366</span> <span class=err>66894866</span>        <span class=nf>mov</span>     <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mh>66h</span><span class=p>],</span><span class=nb>cx</span>
</span></span><span class=line><span class=cl><span class=err>8284736</span><span class=nf>a</span> <span class=mi>33</span><span class=nv>c9</span>            <span class=nv>xor</span>     <span class=nb>ecx</span><span class=p>,</span><span class=nb>ecx</span>
</span></span><span class=line><span class=cl><span class=err>8284736</span><span class=nf>c</span> <span class=mi>6</span><span class=nv>a10</span>            <span class=nv>push</span>    <span class=mh>10h</span>
</span></span><span class=line><span class=cl><span class=err>8284736</span><span class=nf>e</span> <span class=mi>66894864</span>        <span class=nv>mov</span>     <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mh>64h</span><span class=p>],</span><span class=nb>cx</span>
</span></span><span class=line><span class=cl><span class=err>82847372</span> <span class=err>66894860</span>        <span class=nf>mov</span>     <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mh>60h</span><span class=p>],</span><span class=nb>cx</span>
</span></span><span class=line><span class=cl><span class=err>82847376</span> <span class=err>59</span>              <span class=nf>pop</span>     <span class=nb>ecx</span>
</span></span><span class=line><span class=cl><span class=err>82847377</span> <span class=err>66894808</span>        <span class=nf>mov</span>     <span class=kt>word</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>eax</span><span class=o>+</span><span class=mi>8</span><span class=p>],</span><span class=nb>cx</span>
</span></span><span class=line><span class=cl><span class=err>8284737</span><span class=nf>b</span> <span class=mi>5</span><span class=nv>d</span>              <span class=nv>pop</span>     <span class=nb>ebp</span>
</span></span><span class=line><span class=cl><span class=err>8284737</span><span class=nf>c</span> <span class=nv>c20400</span>          <span class=nv>ret</span>     <span class=mi>4</span>
</span></span></code></pre></td></tr></table></div></div><p>We obtain the function prototype: (<a href=https://github.com/hoangduit/reactos/blob/63682957b86d77c7d82e7b887797ef82ea92d271/reactos/ntoskrnl/ke/powerpc/cpu.c target=_blank rel="noopener noreffer">source</a>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>VOID</span>
</span></span><span class=line><span class=cl><span class=n>NTAPI</span>
</span></span><span class=line><span class=cl><span class=nf>KiInitializeTSS</span><span class=p>(</span><span class=n>IN</span> <span class=n>PKTSS</span> <span class=n>Tss</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Structure of <code>_KTSS</code>:</p></div><div class=post-footer><a href=/posts/practical-reverse-engineering/2017-07-16-practical-reverse-engineering-exercise-solutions-kiinitializetss/>Read More</a><div class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/practical-reverse-engineering/>Practical Reverse Engineering</a>,&nbsp;<a href=/tags/x64/>X64</a>,&nbsp;<a href=/tags/x86/>X86</a></div></div></article><ul class=pagination><li class=page-item><span class=page-link><a href=/>1</a></span></li><li class=page-item><span class=page-link aria-hidden=true>&mldr;</span></li><li class=page-item><span class=page-link><a href=/page/3/>3</a></span></li><li class=page-item><span class=page-link><a href=/page/4/>4</a></span></li><li class="page-item active"><span class=page-link><a href=/page/5/>5</a></span></li><li class=page-item><span class=page-link><a href=/page/6/>6</a></span></li></ul></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.146.4">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:1e3},data:{"id-1":"Another blog about software security issues"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>